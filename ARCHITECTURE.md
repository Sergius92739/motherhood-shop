# Архитектура проекта

## Оглавление

- [Обзор архитектуры](#обзор-архитектуры)
- [Принципы проектирования](#принципы-проектирования)
- [Структура проекта](#структура-проекта)
- [Модульная архитектура](#модульная-архитектура)
- [Потоки данных](#потоки-данных)
- [Безопасность](#безопасность)
- [Масштабирование](#масштабирование)
- [Мониторинг и логирование](#мониторинг-и-логирование)

## Обзор архитектуры
### Архитектурный стиль
#### Проект использует многослойную (layered) архитектуру с элементами микросервисного подхода для интеграций с внешними сервисами.

### Ключевые характеристики
- `Фронтенд`: Next.js 14 с App Router, Server/Client Components

- `Бэкенд`: Next.js API Routes (Route Handlers)

- `База данных`: PostgreSQL с Prisma ORM

- `Кэширование`: Redis (опционально)

- `Контейнеризация`: Docker + Docker Compose

- `Деплой`: VDS с Nginx reverse proxy

## Диаграмма высокого уровня
```text
┌─────────────────────────────────────────────────────────────┐
│                    Пользовательский слой                    │
│  (Browser, Mobile App, API Clients)                         │
└──────────────────────────────┬──────────────────────────────┘
                               │
┌──────────────────────────────▼──────────────────────────────┐
│                   Презентационный слой                      │
│  (Next.js App Router, React Components, Pages)              │
└──────────────────────────────┬──────────────────────────────┘
                               │
┌──────────────────────────────▼──────────────────────────────┐
│                    Бизнес-логика слой                       │
│  (Модули: auth, catalog, cart, order, etc.)                 │
└──────────────────────────────┬──────────────────────────────┘
                               │
┌──────────────────────────────▼──────────────────────────────┐
│                    Доступ к данным слой                     │
│  (Prisma ORM, API Clients, External Services)               │
└──────────────────────────────┬──────────────────────────────┘
                               │
┌──────────────────────────────▼──────────────────────────────┐
│                  Хранилище данных слой                      │
│  (PostgreSQL, Redis, Cloudinary, External APIs)             │
└─────────────────────────────────────────────────────────────┘
```
## Принципы проектирования
### 1. SOLID принципы
- `Single Responsibility`: Каждый модуль решает одну задачу

- `Open/Closed`: Модули открыты для расширения, закрыты для изменения

- `Liskov Substitution`: Интерфейсы позволяют заменять реализации

- `Interface Segregation`: Много специализированных интерфейсов

- `Dependency Inversion`: Зависимость от абстракций, а не реализаций

### 2. Принципы реактивной архитектуры
- Отзывчивость: Быстрый отклик UI, спиннеры при загрузке

- Устойчивость: Ошибки в одном модуле не ломают всю систему

- Эластичность: Система масштабируется под нагрузку

- Гибкость: Легкость внесения изменений

### 3. Паттерны проектирования
- `Repository`: Для работы с данными

- `Factory`: Создание сложных объектов

- `Strategy`: Выбор алгоритмов (например, платежных провайдеров)

- `Observer`: Система уведомлений

- `Middleware`: Обработка запросов

## Структура проекта
### Корневая структура
```text
motherhood-shop/
├── src/                    # Исходный код
│   ├── modules/           # Бизнес-модули
│   ├── app/              # Next.js App Router
│   ├── components/       # React компоненты
│   ├── lib/             # Библиотеки и утилиты
│   ├── shared/          # Общие типы и константы
│   └── utils/           # Вспомогательные функции
├── prisma/              # Схема базы данных
├── public/              # Статические файлы
├── scripts/             # Вспомогательные скрипты
├── tests/               # Тесты
└── docker/              # Docker конфигурации
```
### Организация кода по модулям
 Каждый модуль имеет следующую структуру:
```text
modules/[module-name]/
├── types/              # TypeScript типы и интерфейсы
├── services/           # Бизнес-логика
├── api/               # API handlers (Route Handlers)
├── components/        # React компоненты (если есть)
├── hooks/             # React hooks (если есть)
├── utils/             # Вспомогательные функции
├── schemas/           # Zod схемы для валидации
└── index.ts           # Публичный интерфейс модуля
```
## Модульная архитектура
## 1. Модуль Auth (Аутентификация)
### Назначение: Управление пользователями и сессиями

#### Компоненты:
- ```AuthService```: Основная бизнес-логика

- ```SessionService```: Управление сессиями

- ```TokenService```: Работа с JWT токенами

- ```PasswordService```: Хеширование паролей

#### Интерфейсы:

```typescript
interface AuthService {
  register(input: RegisterInput): Promise<User>
  login(credentials: LoginInput): Promise<AuthResponse>
  logout(sessionId: string): Promise<void>
  refreshToken(refreshToken: string): Promise<TokenPair>
  forgotPassword(email: string): Promise<void>
  resetPassword(token: string, newPassword: string): Promise<void>
}
```
#### Взаимодействия:
- Использует ``User`` сущность из Prisma

- Взаимодействует с модулем `notification` для отправки email

- Хранит сессии в Redis (опционально)

## 2. Модуль `Catalog` (Каталог)
### Назначение: Управление товарами и категориями
#### Компоненты:
- `ProductService`: Управление товарами

- `CategoryService`: Управление категориями

- `SearchService`: Поиск по каталогу

- `FilterService`: Фильтрация товаров

#### Особенности:
- Поддержка вариаций товаров (размер, цвет, материал)

- Древовидная структура категорий

- Полнотекстовый поиск

- Кэширование популярных запросов

#### Оптимизации:
- ISR (Incremental Static Regeneration) для страниц категорий

- Ленивая загрузка изображений

- Виртуализация списков для больших каталогов

## 3. Модуль `Cart` (Корзина)
### Назначение: Управление корзиной покупок
#### Компоненты:
- CartService: Основная логика корзины

- CartCalculator: Расчет стоимости

- CartStorage: Хранение состояния корзины

#### Особенности:
- Поддержка гостевых корзин (localStorage)

- Слияние корзин при авторизации

- Валидация доступности товаров

- Применение скидок и купонов
#### Состояние:
```typescript
interface CartState {
  items: CartItem[]
  totals: CartTotals
  coupon?: Coupon
  lastUpdated: Date
}
```

## 4. Модуль `Order` (Заказы)
### Назначение: Оформление и управление заказами

#### Компоненты:
- `OrderService`: Создание и управление заказами

- `CheckoutService`: Процесс оформления заказа

- `OrderProcessor`: Обработка состояний заказа

#### Состояния заказа:
```text
PENDING → PROCESSING → PAID → SHIPPED → DELIVERED → COMPLETED
          ↓           ↓       ↓
        CANCELLED   FAILED  RETURNED
```
## 5. Модуль `Payment` (Платежи)
### Назначение: Интеграция с платежными системами
#### Архитектура:
```text
┌─────────┐     ┌──────────────┐     ┌─────────────┐
│  Order  │────▶│ PaymentService│────▶│   ЮKassa   │
└─────────┘     └──────────────┘     └─────────────┘
                       │
                       ▼
                ┌──────────────┐
                │ WebhookHandler│
                └──────────────┘
```
#### Стратегии:
- ЮKassa (основная)

- Резервная стратегия (на случай сбоя)

- Тестовый режим для разработки

#### Безопасность:
- Верификация подписей webhook

- Idempotency keys для предотвращения дублирования

- Логирование всех транзакций
## 6. Модуль `Delivery` (Доставка)
### Назначение: Расчет и управление доставкой
#### Провайдеры:
- Яндекс Доставка (основной)

- Почта России (резервный)

- Самовывоз (из магазина)

## 7. Модуль `User` (Пользователь)
### Назначение: Личный кабинет и профиль
#### Компоненты:
- `ProfileService`: Управление профилем

- `AddressService`: Управление адресами

- `NotificationService`: Уведомления в ЛК

#### Особенности для магазина:
- Отслеживание срока беременности

- Персонализированные рекомендации

- История покупок с фильтрацией
## 8. Модуль `Blog` (Блог)
### Назначение: Публикация статей

#### Особенности:
- Поддержка markdown и rich-text

- SEO оптимизация

- Связанные статьи

- Статистика просмотров

#### Оптимизации:
- SSG для статических страниц статей

- ISR для обновления контента

- Предзагрузка связанных статей
## 9. Модуль `Review` (Отзывы)
### Назначение: Управление отзывами и рейтингами

#### Особенности:
- Модерация отзывов

- Верификация покупок

- Медиа вложения (фото, видео)

- Рейтинги товаров

#### Модерация:
- Автоматическая проверка на спам

- Ручная модерация в админке

- Уведомление пользователя о публикации

## 10. Модуль `Loyalty` (Лояльность)
### Назначение: Программа лояльности и скидки

#### Система баллов:
- Начисление за покупки

- Начисление за отзывы

- Срок действия баллов

- Обмен на скидки

#### Купоны:
- Промо-коды

- Персональные купоны

- Ограничения по времени и использованию

## 11. Модуль `Admin` (Админ-панель)
### Назначение: Управление магазином

#### Возможности:
- Управление товарами и категориями

- Обработка заказов

- Модерация отзывов

- Просмотр статистики

- Управление пользователями

#### Безопасность:
- RBAC (Role-Based Access Control)

- Логирование действий

- Two-factor authentication (опционально)

## 12. Модуль `Notification` (Уведомления)
### Назначение: Отправка уведомлений

#### Каналы:
- Email (через SMTP или Resend)

- Push-уведомления (web push)

- In-app уведомления

- SMS (опционально)

#### Шаблоны:
- Подтверждение заказа

- Статус доставки

- Напоминания

- Маркетинговые рассылки
## 13. Модуль `Analytics` (Аналитика)
### Назначение: Сбор и анализ данных

#### Собираемые метрики:
- Просмотры товаров

- Конверсии

- Источники трафика

- Поведение пользователей

#### Интеграции:
- Google Analytics

- Yandex Metrica

- Внутренняя аналитика

# Потоки данных
## 1. Поток оформления заказа
```text
1. Пользователь добавляет товары в корзину
2. Переход к оформлению заказа
3. Валидация корзины и адреса
4. Расчет доставки (DeliveryService)
5. Создание заказа (OrderService)
6. Резервирование товаров (InventoryService)
7. Создание платежа (PaymentService)
8. Отправка уведомлений (NotificationService)
9. Обновление аналитики (AnalyticsService)
```
## 2. Поток оплаты (webhook)
```text
1. ЮKassa отправляет webhook
2. Верификация подписи
3. Обновление статуса платежа
4. Обновление статуса заказа
5. Если оплата успешна:
   - Подтверждение резерва товаров
   - Создание доставки
   - Отправка уведомлений
6. Логирование транзакции
```
## 3. Поток синхронизации данных
```text
1. Изменение товара в админке
2. Инвалидация кэша товара
3. Обновление индексов поиска
4. Обновление статических страниц (ISR)
5. Синхронизация с внешними системами
```
# Безопасность
## Уровни безопасности
### 1. Сетевая безопасность
- HTTPS через Nginx

- Firewall правила

- Rate limiting

- DDoS защита

### 2. Безопасность приложения
- Валидация всех входных данных

- Защита от XSS, CSRF, SQL инъекций

- JWT токены с коротким временем жизни

- Хеширование паролей (bcrypt)

### 3. Безопасность данных
- Шифрование чувствительных данных

- Регулярное резервное копирование

- Маскирование данных в логах

- SSL для соединений с БД

### 4. Безопасность API
- Аутентификация по токенам

- Авторизация по ролям

- Валидация запросов

- Лимиты на запросы
## Меры безопасности по модулям
### `Auth` модуль:
- Брутфорс защита

- Блокировка аккаунтов

- Сложность паролей

- 2FA (опционально)

### `Payment` модуль:
- Верификация webhook

- Idempotency keys

А- удит транзакций

### `Admin` модуль:
- IP whitelist

- Сессионный таймаут

- Логирование действий

# Масштабирование
## Горизонтальное масштабирование
### Уровень 1: Stateless приложение
```yaml
# Docker Compose с масштабированием
services:
  app:
    image: motherhood-shop
    deploy:
      replicas: 3
    environment:
      - DATABASE_URL=postgresql://...
      - REDIS_URL=redis://...
```
### Уровень 2: База данных
- Репликация PostgreSQL

- Чтение с реплик

- Шардирование по необходимости

### Уровень 3: Кэширование
- Redis кластер

- Кэширование запросов к БД

- Сессии в Redis
## Вертикальное масштабирование
### Оптимизации:
- Кэширование на уровне приложения

- CDN для статических файлов

- Оптимизация запросов к БД

- Ленивая загрузка
## Стратегии масштабирования по модулям
### `Catalog`:
- Кэширование популярных товаров

- Elasticsearch для поиска

- CDN для изображений

### `Cart`:
- Сессии в Redis

- Оптимистичные обновления

- Очереди для обновлений

### `Order`:
- Очереди для обработки

- Батчинг запросов

- Архивация старых заказов

## Мониторинг и логирование
### Система мониторинга
### Уровни мониторинга:
1. Инфраструктура: CPU, RAM, диски, сеть

2. Приложение: Запросы, ошибки, производительность

3. Бизнес-метрики: Заказы, конверсии, доход

### Инструменты:
- `Sentry`: Отслеживание ошибок

- `Pino`: Структурированное логирование

- `Prometheus` + Grafana: Метрики

- `Logrotate`: Ротация логов
## Логирование по модулям
### Формат логов:
```json
{
  "timestamp": "2024-01-15T10:30:00Z",
  "level": "info",
  "module": "order",
  "method": "createOrder",
  "orderId": "ord_123",
  "userId": "usr_456",
  "duration": 125,
  "status": "success"
}
```
### Критические события:
- Ошибки оплаты

- Сбои интеграций

- Попытки взлома

- Критические бизнес-события

## Алертинг
### Каналы уведомлений:
- Email для администраторов

- Telegram/Slack для devops

- SMS для критических сбоев

### Пороги срабатывания:
- Ошибки > 5% в течение 5 минут

- Время ответа > 2 секунд

- Доступность < 99.9%

# Заключение
### Данная архитектура обеспечивает:

1. Гибкость: Легкость внесения изменений

2. Масштабируемость: Рост без переписывания

3. Надежность: Отказоустойчивость

4. Безопасность: Защита данных и транзакций

5. Производительность: Быстрая загрузка и отклик

Архитектура спроектирована с учетом специфики интернет-магазина товаров для беременных, включая особенности целевой аудитории, требования к безопасности и необходимость гибкого управления контентом.
